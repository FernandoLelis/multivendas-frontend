<div class="modal-overlay" (click)="fechar()">
  <div class="modal-content large-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ tituloModal }}</h2>
      <button class="btn-fechar" (click)="fechar()">√ó</button>
    </div>
    
    <div class="form-container">
      <form class="compra-form" (ngSubmit)="salvarCompra()">
        
        <!-- === SE√á√ÉO 1: DADOS DA COMPRA === -->
        <div class="form-section">
          <!-- ID do Pedido - 100% -->
          <div class="form-group full-width">
            <label for="idPedidoCompra">ID do Pedido de Compra *</label>
            <input type="text" id="idPedidoCompra" name="idPedidoCompra" 
                   [(ngModel)]="compraEdit.idPedidoCompra" required 
                   placeholder="Ex: PO-12345-2024">
          </div>
          
          <!-- Fornecedor e Data - 50%/50% -->
          <div class="form-row">
            <div class="form-group half-width">
              <label for="fornecedor">Fornecedor *</label>
              <input type="text" id="fornecedor" name="fornecedor" 
                     [(ngModel)]="compraEdit.fornecedor" required
                     placeholder="Nome do fornecedor">
            </div>
            
            <div class="form-group half-width">
              <label for="dataEntrada">Data da Compra *</label>
              <input type="date" id="dataEntrada" name="dataEntrada" 
                     [(ngModel)]="compraEdit.dataEntrada" required>
            </div>
          </div>

          <!-- ‚úÖ CATEGORIA FIXA - APENAS PRODUTOS (n√£o edit√°vel) -->
          <!-- <div class="form-group full-width">
            <label for="categoria">Categoria</label>
            <input type="text" id="categoria" name="categoria" 
                   [(ngModel)]="compraEdit.categoria" 
                   value="Produto" 
                   readonly
                   class="campo-bloqueado">
          </div> -->
        </div>

        <!-- === SE√á√ÉO 2: ADICIONAR PRODUTO AO CARRINHO === -->
        <div class="form-section">
          <div class="carrinho-add-container">
            <!-- Produto -->
            <div class="form-group">
              <label for="produtoSelecionado">Produto</label>
              <select id="produtoSelecionado" 
                      (change)="onProdutoSelecionado($event)"
                      name="produtoSelecionado">
                <option value="">Selecione um produto</option>
                <option *ngFor="let produto of produtos" [value]="produto.id">
                  {{ produto.nome }} ({{ produto.sku }}) - Estoque: {{ produto.quantidadeEstoqueTotal }}
                </option>
                <option value="novo">+ Cadastrar Novo Produto</option>
              </select>
            </div>
            
            <!-- Quantidade, Custo Unit√°rio e Custo Total - 33%/33%/33% -->
            <div class="form-row-three">
              <div class="form-group third-width">
                <label for="quantidadeSelecionada">Quantidade</label>
                <input type="number" id="quantidadeSelecionada" 
                       [(ngModel)]="quantidadeSelecionada"
                       [ngModelOptions]="{standalone: true}"
                       name="quantidadeSelecionada" min="1" value="1"
                       (input)="onQuantidadeChange()"
                       (change)="calcularCustoTotal()">
              </div>
              
              <div class="form-group third-width">
                <label for="custoUnitarioSelecionado">Custo Unit√°rio (R$)</label>
                <input type="number" id="custoUnitarioSelecionado" 
                       [(ngModel)]="custoUnitarioSelecionado"
                       [ngModelOptions]="{standalone: true}"
                       name="custoUnitarioSelecionado" step="0.01" min="0" placeholder="0.00"
                       (input)="calcularCustoTotal()">
              </div>
              
              <div class="form-group third-width">
                <label for="custoTotalSelecionado">Custo Total (R$)</label>
                <input type="number" id="custoTotalSelecionado" 
                       [(ngModel)]="custoTotalSelecionado"
                       [ngModelOptions]="{standalone: true}"
                       name="custoTotalSelecionado" step="0.01" min="0" placeholder="0.00"
                       (input)="calcularCustoUnitario()">
              </div>
            </div>
            
            <!-- ‚úÖ ALERTA SE PRODUTO J√Å TEM ESTOQUE -->
            <div *ngIf="produtoJaNoEstoque && produtoSelecionado" class="alerta-estoque">
              <div class="alerta-content">
                <span class="alerta-icon">‚ÑπÔ∏è</span>
                <div class="alerta-texto">
                  <strong>Produto j√° tem estoque!</strong>
                  <br>
                  Estoque atual: {{ saldoAtual }} unidades
                  <br>
                  Esta compra ir√° criar um novo lote no sistema PEPS.
                </div>
              </div>
            </div>
            
            <!-- ‚úÖ BOT√ÉO ADICIONAR AO CARRINHO -->
            <div class="form-group full-width">
              <button type="button" 
                      class="btn-adicionar" 
                      (click)="adicionarAoCarrinho()"
                      [disabled]="!produtoSelecionado">
                <span *ngIf="!produtoSelecionado">Selecione um produto</span>
                <span *ngIf="produtoSelecionado">
                  + Adicionar ao Carrinho
                </span>
              </button>
            </div>
          </div>
        </div>

        <!-- === SE√á√ÉO 3: CARRINHO DE PRODUTOS === -->
        <div class="form-section" *ngIf="compraEdit.itens.length > 0">
          <div class="carrinho-container">
            <!-- Tabela de produtos -->
            <div class="carrinho-table">
              <div class="carrinho-header">
                <div class="carrinho-col produto">Produto</div>
                <div class="carrinho-col quantidade">Quantidade</div>
                <div class="carrinho-col preco">Custo Unit√°rio</div>
                <div class="carrinho-col total">Total</div>
                <div class="carrinho-col acoes">A√ß√µes</div>
              </div>
              
              <div class="carrinho-body">
                <div class="carrinho-row" *ngFor="let item of compraEdit.itens; let i = index">
                  <div class="carrinho-col produto">
                    <strong>{{ item.produtoNome || 'Produto ' + item.produtoId }}</strong>
                    <small *ngIf="item.produtoSku">SKU: {{ item.produtoSku }}</small>
                  </div>
                  
                  <!-- ‚úÖ CAMPOS BLOQUEADOS NO CARRINHO -->
                  <div class="carrinho-col quantidade">
                    <input type="number" 
                           [(ngModel)]="item.quantidade"
                           [ngModelOptions]="{standalone: true}"
                           min="1" 
                           readonly
                           (click)="atualizarQuantidade(item, item.quantidade)"
                           class="campo-bloqueado">
                  </div>
                  
                  <div class="carrinho-col preco">
                    <input type="number" 
                           [(ngModel)]="item.custoUnitario"
                           [ngModelOptions]="{standalone: true}"
                           step="0.01" min="0"
                           readonly
                           (click)="atualizarCustoUnitario(item, item.custoUnitario || 0)"
                           class="campo-bloqueado">
                  </div>
                  
                  <div class="carrinho-col total">
                    {{ (item.custoTotal || 0) | brlCurrency }}
                  </div>
                  
                  <div class="carrinho-col acoes">
                    <button type="button" class="btn-remover" 
                            (click)="removerDoCarrinho(i)" title="Remover">
                      üóëÔ∏è
                    </button>
                  </div>
                </div>
              </div>
              
              <!-- Total do Carrinho -->
              <div class="carrinho-footer">
                <div class="carrinho-total">
                  <span class="total-label">Total da Compra:</span>
                  <span class="total-value">{{ calcularTotalCarrinho() | brlCurrency }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- === SE√á√ÉO 4: OBSERVA√á√ïES === -->
        <div class="form-section">
          <div class="form-group full-width">
            <label for="observacoes">Observa√ß√µes</label>
            <textarea id="observacoes" name="observacoes" rows="3" 
                      [(ngModel)]="compraEdit.observacoes"
                      placeholder="Observa√ß√µes adicionais (opcional)"></textarea>
          </div>
        </div>

        <!-- === SE√á√ÉO 5: A√á√ïES === -->
        <div class="form-section">
          <div class="form-actions">
            <button type="button" class="btn-cancelar" (click)="fechar()">Cancelar</button>
            
            <button type="submit" class="btn-salvar" 
                    [disabled]="compraEdit.itens.length === 0">
              {{ modoEdicao ? 'Atualizar' : 'Salvar' }} Compra
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal de Produto -->
<app-produto-form 
  *ngIf="mostrarModalProduto"
  (fecharModal)="fecharModalProduto()"
  (produtoSalvo)="onProdutoSalvo()">
</app-produto-form>