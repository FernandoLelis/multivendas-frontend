<div class="modal-overlay" (click)="fechar()">
  <div class="modal-content large-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ tituloModal }}</h2>
      <button class="btn-fechar" (click)="fechar()">×</button>
    </div>
    
    <div class="form-container">
      <form class="venda-form" (ngSubmit)="salvarVenda()">
        <!-- Plataforma - 100% -->
        <div class="form-section">
          <div class="form-group full-width">
            <label for="plataforma">Plataforma *</label>
            <select id="plataforma" name="plataforma" 
                    [(ngModel)]="vendaEdit.plataforma" required>
              <option *ngFor="let plataforma of plataformas" [value]="plataforma">
                {{ plataforma }}
              </option>
            </select>
          </div>
        </div>

        <!-- ✅ CORREÇÃO: Selecionar Produto - REMOVIDA A INFORMAÇÃO ABAIXO DO CAMPO -->
        <div class="form-section">
          <div class="form-group">
            <label for="produto">Produto *</label>
            <select id="produto" name="produto" 
                    [(ngModel)]="vendaEdit.produtoId" 
                    (change)="onProdutoSelecionado($event)" required>
              <option value="">Selecione um produto</option>
              <option *ngFor="let produto of produtos" [value]="produto.id">
                {{ produto.nome }} ({{ produto.sku }})
              </option>
              <option value="novo">+ Cadastrar Novo Produto</option>
            </select>
            
            <!-- ✅ REMOVIDO: Bloco do produto selecionado abaixo do campo -->
          </div>
        </div>

        <!-- Quantidade - 100% -->
        <div class="form-section">
          <div class="form-group full-width">
            <label for="quantidade">Quantidade *</label>
            <input type="number" id="quantidade" name="quantidade" 
                   [(ngModel)]="vendaEdit.quantidade" min="1" required
                   (input)="onQuantidadeChange()">
          </div>
        </div>

        <!-- ✅ ALERTA DE ESTOQUE INSUFICIENTE - ABAIXO DO CAMPO QUANTIDADE -->
        <div *ngIf="estoqueInsuficiente" class="alerta-estoque">
          <div class="alerta-content">
            <span class="alerta-icon">⚠️</span>
            <div class="alerta-texto">
              <strong>Estoque insuficiente!</strong>
              <br>
              Disponível: {{ estoqueDisponivel }} unidades
              <br>
              Solicitado: {{ quantidadeSolicitada }} unidades
            </div>
            <button type="button" class="btn-comprar-estoque" 
                    (click)="abrirModalCompra()">
              Comprar Mais
            </button>
          </div>
        </div>

        <!-- ✅ CORREÇÃO: Preço Unitário e Preço Total - 50%/50% -->
        <div class="form-section">
          <div class="form-row">
            <div class="form-group half-width">
              <label for="precoUnitario">Preço Unitário *</label>
              <input type="number" id="precoUnitario" name="precoUnitario" 
                     [(ngModel)]="precoUnitario" 
                     step="0.01"
                     (input)="calcularPrecoTotal()"
                     placeholder="0.00" required>
            </div>

            <div class="form-group half-width">
              <label for="precoTotal">Preço Total</label>
              <input type="number" id="precoTotal" name="precoTotal" 
                     [(ngModel)]="precoTotal" 
                     step="0.01"
                     (input)="calcularPrecoUnitario()"
                     placeholder="0.00">
            </div>
          </div>
        </div>

        <!-- Frete Pago pelo Cliente e Custo Real do Envio - 50%/50% -->
        <div class="form-section">
          <div class="form-row">
            <div class="form-group half-width">
              <label for="fretePagoPeloCliente">Frete Pago pelo Cliente</label>
              <input type="number" id="fretePagoPeloCliente" name="fretePagoPeloCliente" 
                     [(ngModel)]="vendaEdit.fretePagoPeloCliente" 
                     step="0.01"
                     placeholder="0.00">
            </div>

            <div class="form-group half-width">
              <label for="custoEnvio">Custo Real do Envio</label>
              <input type="number" id="custoEnvio" name="custoEnvio" 
                     [(ngModel)]="vendaEdit.custoEnvio" 
                     step="0.01"
                     placeholder="0.00">
            </div>
          </div>
        </div>

        <!-- Tarifa da Plataforma e Data e Hora - 50%/50% -->
        <div class="form-section">
          <div class="form-row">
            <div class="form-group half-width">
              <label for="tarifaPlataforma">Tarifa da Plataforma</label>
              <input type="number" id="tarifaPlataforma" name="tarifaPlataforma" 
                     [(ngModel)]="vendaEdit.tarifaPlataforma" 
                     step="0.01"
                     placeholder="0.00">
            </div>

            <div class="form-group half-width">
              <label for="data">Data e Hora *</label>
              <input type="datetime-local" id="data" name="data" 
                    [(ngModel)]="vendaEdit.data" 
                    required
                    (blur)="validarData()"
                    (input)="validarData()">
          </div>
          </div>
        </div>

        <!-- ID do Pedido - 100% -->
        <div class="form-section">
          <div class="form-group full-width">
            <label for="idPedido">ID do Pedido *</label>
            <input type="text" id="idPedido" name="idPedido" 
                   [(ngModel)]="vendaEdit.idPedido" required 
                   placeholder="Ex: 123-4567890-1234567">
          </div>
        </div>

        <!-- ✅ CORREÇÃO: Informações de Cálculo (apenas modo edição) -->
        <div class="form-section" *ngIf="modoEdicao">
          <div class="calculos-section">
            <div class="info-row">
              <span class="label">Custo do Produto:</span>
              <span class="value">{{ vendaEdit.custoProdutoVendido | brlCurrency }}</span>
            </div>
            
            <div class="info-row" *ngIf="vendaEdit.custoEfetivoTotal">
              <span class="label">Custo Efetivo Total:</span>
              <span class="value">{{ vendaEdit.custoEfetivoTotal | brlCurrency }}</span>
            </div>
            
            <div class="info-row" *ngIf="vendaEdit.lucroLiquido !== undefined">
              <span class="label">Lucro Líquido:</span>
              <span class="value" [class.positive]="vendaEdit.lucroLiquido >= 0" 
                             [class.negative]="vendaEdit.lucroLiquido < 0">
                {{ vendaEdit.lucroLiquido | brlCurrency }}
              </span>
            </div>
            
            <div class="info-row" *ngIf="vendaEdit.roi !== undefined">
              <span class="label">ROI:</span>
              <span class="value" [class.positive]="vendaEdit.roi >= 0" 
                             [class.negative]="vendaEdit.roi < 0">
                {{ vendaEdit.roi | number:'1.2-2' }}%
              </span>
            </div>
          </div>
        </div>

        <!-- Ações -->
        <div class="form-actions">
          <button type="button" class="btn-cancelar" (click)="fechar()">Cancelar</button>
          <button type="submit" class="btn-salvar">
            {{ modoEdicao ? 'Atualizar' : 'Salvar' }} Venda
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ✅ MODAL DE PRODUTO -->
<app-produto-form 
  *ngIf="mostrarModalProduto"
  (fecharModal)="fecharModalProduto()"
  (produtoSalvo)="onProdutoSalvo()">
</app-produto-form>