<div class="modal-overlay" (click)="fechar()">
  <div class="modal-content large-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ tituloModal }}</h2>
      <button class="btn-fechar" (click)="fechar()">√ó</button>
    </div>
    
    <div class="form-container">
      <form class="venda-form" (ngSubmit)="salvarVenda()">
        
        <!-- === SE√á√ÉO 1: DADOS DA VENDA === -->
        <div class="form-section">
          <!-- ID do Pedido - 100% -->
          <div class="form-group full-width">
            <label for="idPedido">ID do Pedido *</label>
            <input type="text" id="idPedido" name="idPedido" 
                   [(ngModel)]="vendaEdit.idPedido" required 
                   placeholder="Ex: 123-4567890-1234567">
          </div>
          
          <!-- Plataforma e Data - 50%/50% -->
          <div class="form-row">
            <div class="form-group half-width">
              <label for="plataforma">Plataforma *</label>
              <select id="plataforma" name="plataforma" 
                      [(ngModel)]="vendaEdit.plataforma" required>
                <option *ngFor="let plataforma of plataformas" [value]="plataforma">
                  {{ plataforma }}
                </option>
              </select>
            </div>
            
            <div class="form-group half-width">
              <label for="data">Data da Venda *</label>
              <input type="date" id="data" name="data" 
                     [(ngModel)]="vendaEdit.data" 
                     required
                     (blur)="validarData()"
                     (input)="validarData()">
            </div>
          </div>
        </div>

        <!-- === SE√á√ÉO 2: ADICIONAR PRODUTO AO CARRINHO === -->
        <div class="form-section">
          <div class="carrinho-add-container">
            <!-- Produto -->
            <div class="form-group">
              <label for="produtoSelecionado">Produto</label>
              <select id="produtoSelecionado" 
                      (change)="onProdutoSelecionado($event)"
                      name="produtoSelecionado">
                <option value="">Selecione um produto</option>
                <option *ngFor="let produto of produtos" [value]="produto.id">
                  {{ produto.nome }} ({{ produto.sku }}) - Estoque: {{ produto.quantidadeEstoqueTotal }}
                </option>
                <option value="novo">+ Cadastrar Novo Produto</option>
              </select>
            </div>
            
            <!-- Quantidade, Pre√ßo Unit√°rio e Pre√ßo Total - 33%/33%/33% -->
            <div class="form-row-three">
              <div class="form-group third-width">
                <label for="quantidadeSelecionada">Quantidade</label>
                <input type="number" id="quantidadeSelecionada" 
                       [(ngModel)]="quantidadeSelecionada"
                       name="quantidadeSelecionada" min="1" value="1"
                       (input)="onQuantidadeChange()"
                       (change)="calcularPrecoTotal()">
              </div>
              
              <div class="form-group third-width">
                <label for="precoUnitarioSelecionado">Pre√ßo Unit√°rio (R$)</label>
                <input type="number" id="precoUnitarioSelecionado" 
                       [(ngModel)]="precoUnitarioSelecionado"
                       name="precoUnitarioSelecionado" step="0.01" min="0" placeholder="0.00"
                       (input)="calcularPrecoTotal()">
              </div>
              
              <div class="form-group third-width">
                <label for="precoTotalSelecionado">Pre√ßo Total (R$)</label>
                <input type="number" id="precoTotalSelecionado" 
                       [(ngModel)]="precoTotalSelecionado"
                       name="precoTotalSelecionado" step="0.01" min="0" placeholder="0.00"
                       (input)="calcularPrecoUnitario()">
              </div>
            </div>
            
            <!-- ‚úÖ ALERTA DE ESTOQUE INSUFICIENTE -->
            <div *ngIf="estoqueInsuficiente" class="alerta-estoque">
              <div class="alerta-content">
                <span class="alerta-icon">‚ö†Ô∏è</span>
                <div class="alerta-texto">
                  <strong>Estoque insuficiente!</strong>
                  <br>
                  Dispon√≠vel: {{ estoqueDisponivel }} unidades
                  <br>
                  Solicitado: {{ quantidadeSolicitada }} unidades
                  <br>
                  <span *ngIf="quantidadeNoCarrinho > 0">
                    J√° no carrinho: {{ quantidadeNoCarrinho }} unidades
                  </span>
                </div>
              </div>
            </div>
            
            <!-- ‚úÖ BOT√ÉO √öNICO ADICIONAR/COMPRAR ESTOQUE -->
            <div class="form-group full-width">
              <button type="button" 
                      class="btn-adicionar" 
                      [class.btn-comprar-estoque]="estoqueInsuficiente"
                      (click)="estoqueInsuficiente ? abrirModalCompra() : adicionarAoCarrinho()"
                      [disabled]="!produtoSelecionado || verificandoEstoque">
                <span *ngIf="verificandoEstoque">Verificando estoque...</span>
                <span *ngIf="!verificandoEstoque">
                  <span *ngIf="!produtoSelecionado">Selecione um produto</span>
                  <span *ngIf="produtoSelecionado && !estoqueInsuficiente">
                    + Adicionar ao Carrinho
                  </span>
                  <span *ngIf="produtoSelecionado && estoqueInsuficiente">
                    üõí Comprar Mais Estoque
                  </span>
                </span>
              </button>
            </div>
          </div>
        </div>

        <!-- === SE√á√ÉO 3: CARRINHO DE PRODUTOS === -->
        <div class="form-section" *ngIf="vendaEdit.itens.length > 0">
          <div class="carrinho-container">
            <!-- Tabela de produtos -->
            <div class="carrinho-table">
              <div class="carrinho-header">
                <div class="carrinho-col produto">Produto</div>
                <div class="carrinho-col quantidade">Quantidade</div>
                <div class="carrinho-col preco">Pre√ßo Unit√°rio</div>
                <div class="carrinho-col total">Total</div>
                <div class="carrinho-col acoes">A√ß√µes</div>
              </div>
              
              <div class="carrinho-body">
                <!-- ‚úÖ‚úÖ‚úÖ CORRE√á√ÉO v46.9.2: Usa itensExibicao -->
                <div class="carrinho-row" *ngFor="let itemExibicao of itensExibicao; let i = index">
                  <div class="carrinho-col produto">
                    <strong>{{ itemExibicao.produtoNome }}</strong>
                    <small *ngIf="itemExibicao.produtoSku">SKU: {{ itemExibicao.produtoSku }}</small>
                    <div *ngIf="itemExibicao.quantidadeLotes > 1" class="info-multiplos-lotes">
                      ‚ìò {{ itemExibicao.quantidadeLotes }} lotes PEPS
                    </div>
                    <div *ngIf="erroEstoque[itemExibicao.produtoId]" class="erro-estoque-item">
                      ‚ö†Ô∏è {{ erroEstoque[itemExibicao.produtoId] }}
                    </div>
                  </div>
                  
                  <!-- ‚úÖ‚úÖ‚úÖ CORRE√á√ÉO v46.9.2: Campo separado para quantidade TOTAL -->
                  <div class="carrinho-col quantidade">
                    <input type="number" 
                           [value]="itemExibicao.quantidadeTotal"
                           min="1" 
                           [readonly]="!modoEdicao"
                           (change)="atualizarQuantidadeTotal(itemExibicao, converterParaNumero($event))"
                           [class.campo-bloqueado]="!modoEdicao"
                           [class.campo-editavel]="modoEdicao"
                           title="{{ modoEdicao ? 'Editar quantidade total' : 'Remova e adicione novamente para editar' }}">
                  </div>
                  
                  <!-- ‚úÖ‚úÖ‚úÖ CORRE√á√ÉO v46.9.2: Campo separado para pre√ßo unit√°rio M√âDIO -->
                  <div class="carrinho-col preco">
                    <input type="number" 
                           [value]="itemExibicao.precoUnitarioVenda"
                           step="0.01" min="0"
                           [readonly]="!modoEdicao"
                           (change)="atualizarPrecoUnitarioTotal(itemExibicao, converterParaNumero($event))"
                           [class.campo-bloqueado]="!modoEdicao"
                           [class.campo-editavel]="modoEdicao"
                           title="{{ modoEdicao ? 'Editar pre√ßo unit√°rio' : 'Remova e adicione novamente para editar' }}">
                  </div>
                  
                  <div class="carrinho-col total">
                    {{ itemExibicao.precoTotalItem | brlCurrency }}
                  </div>
                  
                  <div class="carrinho-col acoes">
                    <button type="button" class="btn-remover" 
                            (click)="removerDoCarrinho(i)" title="Remover">
                      üóëÔ∏è
                    </button>
                  </div>
                </div>
              </div>
              
              <!-- Total do Carrinho -->
              <div class="carrinho-footer">
                <div class="carrinho-total">
                  <span class="total-label">Subtotal:</span>
                  <span class="total-value">{{ calcularTotalCarrinho() | brlCurrency }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- === SE√á√ÉO 4: VALORES ADICIONAIS === -->
        <div class="form-section">
          <!-- Frete Pago pelo Cliente e Custo Real do Envio - 50%/50% -->
          <div class="form-row">
            <div class="form-group half-width">
              <label for="fretePagoPeloCliente">Frete Pago pelo Cliente</label>
              <input type="number" id="fretePagoPeloCliente" name="fretePagoPeloCliente" 
                     [(ngModel)]="vendaEdit.fretePagoPeloCliente" 
                     step="0.01"
                     placeholder="0.00">
            </div>

            <div class="form-group half-width">
              <label for="custoEnvio">Custo Real do Envio</label>
              <input type="number" id="custoEnvio" name="custoEnvio" 
                     [(ngModel)]="vendaEdit.custoEnvio" 
                     step="0.01"
                     placeholder="0.00">
            </div>
          </div>

          <!-- Tarifa da Plataforma -->
          <div class="form-row">
            <div class="form-group half-width">
              <label for="tarifaPlataforma">Tarifa da Plataforma</label>
              <input type="number" id="tarifaPlataforma" name="tarifaPlataforma" 
                     [(ngModel)]="vendaEdit.tarifaPlataforma" 
                     step="0.01"
                     placeholder="0.00">
            </div>

            <div class="form-group half-width">
              <!-- Campo vazio para manter alinhamento -->
            </div>
          </div>
        </div>

        <!-- === SE√á√ÉO 5: RESUMO (apenas modo edi√ß√£o) === -->
        <div class="form-section" *ngIf="modoEdicao && vendaEdit.custoProdutoVendido">
          <div class="calculos-section">
            <div class="info-row">
              <span class="label">Pre√ßo Total:</span>
              <span class="value">{{ vendaEdit.precoVenda | brlCurrency }}</span>
            </div>
            
            <div class="info-row">
              <span class="label">Custo Produtos (PEPS):</span>
              <span class="value">{{ vendaEdit.custoProdutoVendido | brlCurrency }}</span>
            </div>
            
            <div class="info-row" *ngIf="vendaEdit.custoEfetivoTotal">
              <span class="label">Custo Efetivo Total:</span>
              <span class="value">{{ vendaEdit.custoEfetivoTotal | brlCurrency }}</span>
            </div>
            
            <div class="info-row" *ngIf="vendaEdit.lucroLiquido !== undefined">
              <span class="label">Lucro L√≠quido:</span>
              <span class="value" [class.positive]="vendaEdit.lucroLiquido >= 0" 
                             [class.negative]="vendaEdit.lucroLiquido < 0">
                {{ vendaEdit.lucroLiquido | brlCurrency }}
              </span>
            </div>
            
            <div class="info-row" *ngIf="vendaEdit.roi !== undefined">
              <span class="label">ROI:</span>
              <span class="value" [class.positive]="vendaEdit.roi >= 0" 
                             [class.negative]="vendaEdit.roi < 0">
                {{ vendaEdit.roi | number:'1.2-2' }}%
              </span>
            </div>
          </div>
        </div>

        <!-- === SE√á√ÉO 6: A√á√ïES === -->
        <div class="form-section">
          <div class="form-actions">
            <button type="button" class="btn-cancelar" (click)="fechar()">Cancelar</button>
            
            <button type="submit" class="btn-salvar" 
                    [disabled]="vendaEdit.itens.length === 0 || temErroEstoque()">
              {{ modoEdicao ? 'Atualizar' : 'Salvar' }} Venda
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal de Produto -->
<app-produto-form 
  *ngIf="mostrarModalProduto"
  (fecharModal)="fecharModalProduto()"
  (produtoSalvo)="onProdutoSalvo()">
</app-produto-form>